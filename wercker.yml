box: golang:1.7
build:
  steps:
  - script:
    name: install-certs
    code: |
      curl --fail -sSL -o ca-certificates.crt https://raw.githubusercontent.com/bagder/ca-bundle/master/ca-bundle.crt
      cp ca-certificates.crt /etc/ssl/certs/
  - script:
    name: link-it
    code: |
      mkdir -p $GOPATH/src/github.com/octoblu
      ln -sf $WERCKER_SOURCE_DIR $GOPATH/src/github.com/octoblu/beekeeper-updater-swarm
  - script:
    name: go-build
    code: CGO_ENABLED=0 go build -a -ldflags '-s' -o beekeeper-updater-swarm .
    cwd: $GOPATH/src/github.com/octoblu/beekeeper-updater-swarm
  - script:
    name: copy-binary
    code: cp beekeeper-updater-swarm "$WERCKER_OUTPUT_DIR"
deploy:
  steps:
  # - script:
  #   name: is-tagged-release
  #   code: git describe &> /dev/null || exit 1
  # - script:
  #   name: is-valid-release
  #   code: |
  #     RAW_VERSION="$(git describe --tags)"
  #     VERSION="${RAW_VERSION%%\-*}"
  #     echo "Checking version $VERSION"
  #     echo "$VERSION" | grep '^v[0-9]\+\.[0-9]\+\.[0-9]\+' > /dev/null
  #     echo "$VERSION" > "${WERCKER_ROOT}/VERSION"
  #     echo "Releasing: $VERSION"
  - script:
    name: test-release
    code: |
      VERSION='dev'
      export VERSION
  - internal/docker-scratch-push:
    username: $DOCKER_HUB_USERNAME
    password: $DOCKER_HUB_PASSWORD
    tag: $VERSION
    cmd: ./beekeeper-updater-swarm
    repository: octoblu/beekeeper-updater-swarm
    registry: https://registry.hub.docker.com
