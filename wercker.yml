build:
  box: golang:1.7
  steps:
  - script:
    name: save-release-tag
    code: |
      git describe --tags --exact --match 'v*.*.*' | tee "${WERCKER_OUTPUT_DIR}/.release_tag"
  - script:
    name: link-it
    code: |
      mkdir -p $GOPATH/src/github.com/octoblu
      ln -sf $WERCKER_SOURCE_DIR $GOPATH/src/github.com/octoblu/beekeeper-updater-swarm
  - script:
    name: go-build
    code: CGO_ENABLED=0 go build -a -ldflags '-s' -o "${WERCKER_OUTPUT_DIR}/beekeeper-updater-swarm"
    cwd: $GOPATH/src/github.com/octoblu/beekeeper-updater-swarm
deploy:
  box:
    id: alpine
    cmd: /bin/sh
  steps:
  - script:
    name: prepare
    code: mv ./beekeeper-updater-swarm /beekeeper-updater-swarm
  - script:
    name: install-packages
    code: |
      echo "@edge http://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
      apk update && apk add ca-certificates
  - script:
    name: get-release-tag
    code: |
      if [ ! -f "$WERCKER_ROOT/.release_tag" ]; then
        echo "Missing .release_tag file"
        return 1
      fi
      export RELEASE_TAG=$(cat $WERCKER_ROOT/.release_tag)
      echo "Release tag: ${RELEASE_TAG}"
  - internal/docker-push:
    username: $DOCKER_HUB_USERNAME
    password: $DOCKER_HUB_PASSWORD
    tag: $RELEASE_TAG
    entrypoint: /beekeeper-updater-swarm
    repository: octoblu/beekeeper-updater-swarm
    registry: https://registry.hub.docker.com/v2
