build:
  box: golang:1.7
  steps:
  - script:
    name: store-tag
    code: git describe --contains $WERCKER_GIT_COMMIT > "${WERCKER_OUTPUT_DIR}/GIT_TAG"
  - script:
    name: link-it
    code: |
      mkdir -p $GOPATH/src/github.com/octoblu
      ln -sf $WERCKER_SOURCE_DIR $GOPATH/src/github.com/octoblu/beekeeper-updater-swarm
  - script:
    name: go-build
    code: CGO_ENABLED=0 go build -a -ldflags '-s' -o "${WERCKER_OUTPUT_DIR}/beekeeper-updater-swarm"
    cwd: $GOPATH/src/github.com/octoblu/beekeeper-updater-swarm
deploy:
  box:
    id: alpine
    cmd: /bin/sh
  steps:
  - script:
    name: prepare
    code: mv ./beekeeper-updater-swarm /beekeeper-updater-swarm
  - script:
    name: is-valid-release
    code: |
      export GIT_TAG="$(cat ./GIT_TAG)"
      echo "$GIT_TAG" | grep '^v[0-9]\+\.[0-9]\+\.[0-9]\+'
      echo "Releasing $GIT_TAG"
  - script:
    name: install-packages
    code: |
      echo "@edge http://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
      apk update && apk add ca-certificates
  - internal/docker-push:
    username: $DOCKER_HUB_USERNAME
    password: $DOCKER_HUB_PASSWORD
    tag: $GIT_TAG
    entrypoint: /beekeeper-updater-swarm
    repository: octoblu/beekeeper-updater-swarm
    registry: https://registry.hub.docker.com
