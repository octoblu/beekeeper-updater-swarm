build:
  box: golang:1.7
  steps:
  - script:
    name: link-it
    code: |
      mkdir -p $GOPATH/src/github.com/octoblu
      ln -sf $WERCKER_SOURCE_DIR $GOPATH/src/github.com/octoblu/beekeeper-updater-swarm
  - script:
    name: go-build
    code: CGO_ENABLED=0 go build -a -ldflags '-s' -o "${WERCKER_OUTPUT_DIR}/beekeeper-updater-swarm"
    cwd: $GOPATH/src/github.com/octoblu/beekeeper-updater-swarm
deploy:
  box:
    id: alpine
    cmd: /bin/sh
  steps:
  - script:
    name: is-tagged-release
    code: git describe &> /dev/null || exit 1
  - script:
    name: is-valid-release
    code: |
      RAW_TAG="$(git describe --tags)"
      GIT_TAG="${RAW_TAG%%\-*}"
      echo "Checking version $GIT_TAG"
      echo "$GIT_TAG" | grep '^v[0-9]\+\.[0-9]\+\.[0-9]\+' > /dev/null
      echo "Releasing: $GIT_TAG"
      export GIT_TAG
  - script:
    name: install-packages
    code: |
      echo "@edge http://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
      apk update && apk add ca-certificates
  - script:
    name: prepare
    code: mv ./beekeeper-updater-swarm /beekeeper-updater-swarm
  - internal/docker-push:
    username: $DOCKER_HUB_USERNAME
    password: $DOCKER_HUB_PASSWORD
    tag: $VERSION
    entrypoint: /beekeeper-updater-swarm
    repository: octoblu/beekeeper-updater-swarm
    registry: https://registry.hub.docker.com
